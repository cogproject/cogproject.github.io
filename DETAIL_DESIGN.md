# 詳細設計書

## 1. システム概要
ブラウザ上で動作する疑似言語インタプリタを提供する。ユーザーは `index.html` のエディタに疑似言語を入力し、実行ボタンまたは `Ctrl/Cmd + Enter` でコードを実行する。実行結果は右側の出力ペインに表示される。

## 2. 構成要素
|ファイル|役割|
|-------|----|
|`pseudo/index.html`|UI レイアウトおよび主要コンポーネントの定義。|
|`pseudo/main.js`|疑似言語から JavaScript への変換・実行と UI 制御。|
|`pseudo/sandbox-worker.js`|Web Worker を用いたサンドボックス環境。|
|`pseudo/manual.html`|言語仕様とサンプルコードの説明。|

## 3. 処理フロー
1. ユーザーがエディタにコードを入力し、実行を指示する。
2. `main.js` の `run()` 関数が呼び出され、コードを疑似言語から JavaScript へ変換する。
3. 変換後のコードを `sandbox-worker.js` に送信し、Web Worker 内で安全に実行する。
4. 実行結果を `stdout` 要素に追記し、必要に応じて `clearOutput()` でリセットする。

## 4. モジュール設計
### 4.1 `main.js`
- **型シノニム (`TYPE_SYNONYMS`)**: `int` や `整数型` などの別名を共通の基底型にマッピングする。
- **入出力管理**: `resetInput()` で入力トークンをリセットし、`__出力` や `__改行` で標準出力を操作する。
- **構造体とメモリ**: `__new()` によりレコード型の初期化、`recordDefs` によるフィールド定義を行う。
- **エラー行番号の逆引き**: `__jsLineToPseudo()` が JavaScript の行番号から元の疑似言語の行番号へマッピングする。
- **UI 操作**: `updateLineNumbers()` や `sanitizeCode()` でエディタ表示を制御する。

### 4.2 `index.html`
- エディタ、出力表示領域、入力欄、サンプル選択などの UI コンポーネントを提供する。
- ボタンとキーボードショートカットで `run()` や `clearOutput()` を呼び出す。

### 4.3 `sandbox-worker.js`
- 受け取った JavaScript コードを `eval` で実行し、`postMessage` で結果をメインスレッドへ返す。
- 実行タイムアウトや例外発生時にはエラーメッセージを返却する。

## 5. データ構造
- `types`: 変数名を型名にマッピングする連想配列。
- `recordDefs`: レコード型名をフィールド情報にマッピングする連想配列。
- `inputTokens`: 入力値を保持する配列。

## 6. エラー処理
- 実行時エラーが発生すると、`__jsLineToPseudo()` を利用して疑似言語上の行番号と該当行を表示する。
- 入力不足などの例外はユーザーへ明示的に通知する。

## 7. 拡張性
- 型シノニムを追加することで複数の表記揺れに対応可能。
- Web Worker を利用しているため、メインスレッドへの影響を最小化しつつ機能拡張が可能。

